/*
 *  test_threaded_neuron_device_connections.sli
 *
 *  This file is part of NEST.
 *
 *  Copyright (C) 2004 The NEST Initiative
 *
 *  NEST is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 2 of the License, or
 *  (at your option) any later version.
 *
 *  NEST is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License
 *  along with NEST.  If not, see <http://www.gnu.org/licenses/>.
 *
 */


 /* BeginDocumentation
Name: testsuite::test_threaded_neuron_device_connections - test for correct creation of neuron-neuron, neuron-device, device-neuron and device-device connections using multiple threads

Synopsis: (test_threaded_neuron_device_connections) run -> dies if assertion fails

Description:
this script creates connections between neurons and devices and checks whether the actually created connections coincide with the expected connections

Author: Jakob Jordan
FirstVersion: January 2016
SeeAlso:
*/

(unittest) run
/unittest using

M_ERROR setverbosity

ResetKernel
0 << /total_num_virtual_procs 2 >> SetStatus

% create nodes
/n1 /iaf_psc_delta Create def
/n2 /iaf_psc_delta Create def
/n3 /iaf_psc_delta Create def
/n4 /spike_detector Create def
/n5 /spike_generator Create def

% neuron-neuron
[n1 n2] [n3 n3] /one_to_one Connect
[n2 n3] [n1] Connect
n2 n1 << /weight 1. >> Connect

% neuron-device
[n1 n1] [n4 n3] /one_to_one Connect
[n2 n3] [n4] Connect
n2 n4 << /weight 1. >> Connect

% device-neuron
[n5 n5] [n2 n3] /one_to_one Connect
[n5 n5] [n1] Connect
n5 n3 << /weight 1. >> Connect

% device-device, n5n5 should be ignored
[n5 n5] [n4 n5] /one_to_one Connect
[n5 n5] [n4] Connect
n5 n4 << /weight 1. >> Connect

/conn << >> GetConnections def

% expected connections with expected threads
/target_conn <[1 3 1] [2 3 1] [2 1 1] [3 1 1] [2 1 1]
              [1 4 1] [1 3 1] [2 4 0] [3 4 1] [2 4 0]
              [5 2 0] [5 3 1] [5 1 1] [5 1 1] [5 3 1]
              [5 4 0] [5 4 0] [5 4 0] [5 4 0]> def

conn {
  target_conn exch cva [[1 2 3]] Part MemberQ assert
} forall
conn length_a target_conn length_a eq assert
